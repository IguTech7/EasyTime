{% extends 'painel/base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">{{ titulo }}</h3>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}" role="alert">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post" id="agendamento-form">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="{{ form.servico.id_for_label }}" class="form-label">{{ form.servico.label }}</label>
                            {{ form.servico }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.funcionario.id_for_label }}" class="form-label">{{ form.funcionario.label }}</label>
                            {{ form.funcionario }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.data_agendamento.id_for_label }}" class="form-label">{{ form.data_agendamento.label }}</label>
                            {{ form.data_agendamento }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_hora_agendamento" class="form-label">Hora Disponível</label>
                            <select id="id_hora_agendamento" name="hora_agendamento" class="form-select" disabled>
                                <option value="">Selecione a Data, Serviço e Profissional</option>
                            </select>
                            <small id="ajuda-hora" class="form-text text-muted"></small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg mt-3">
                                <i class="fas fa-calendar-check me-2"></i> {{ botao_submit }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const servicoField = document.getElementById('id_servico');
        const funcionarioField = document.getElementById('id_funcionario');
        const dataField = document.getElementById('id_data_agendamento');
        const horaSelect = document.getElementById('id_hora_agendamento');
        const ajudaHora = document.getElementById('ajuda-hora');
        
        function updateHorarios() {
            const servicoId = servicoField.value;
            const funcionarioId = funcionarioField.value;
            const data = dataField.value;

            if (!servicoId || !funcionarioId || !data) {
                horaSelect.innerHTML = '<option value="">Selecione Serviço, Profissional e Data</option>';
                horaSelect.disabled = true;
                ajudaHora.textContent = 'Preencha todos os campos para ver os horários.';
                return;
            }

            ajudaHora.textContent = 'Buscando horários disponíveis...';
            horaSelect.disabled = true;
            horaSelect.innerHTML = '';
            
            fetch(`{% url 'agendamentos:disponibilidade' %}?funcionario=${funcionarioId}&data=${data}&servico=${servicoId}`)
                .then(response => response.json())
                .then(data => {
                    horaSelect.disabled = false;
                    
                    if (data.horarios && data.horarios.length > 0) {
                        ajudaHora.textContent = '';
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'Selecione o Horário';
                        horaSelect.appendChild(defaultOption);

                        data.horarios.forEach(horario => {
                            const option = document.createElement('option');
                            option.value = horario;
                            option.textContent = horario;
                            horaSelect.appendChild(option);
                        });
                    } else {
                        ajudaHora.textContent = 'Nenhum horário disponível para esta seleção.';
                        horaSelect.innerHTML = '<option value="">Sem horários</option>';
                        horaSelect.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Erro na busca de horários:', error);
                    ajudaHora.textContent = 'Erro ao buscar horários. Tente novamente.';
                    horaSelect.disabled = true;
                });
        }

        servicoField.addEventListener('change', updateHorarios);
        funcionarioField.addEventListener('change', updateHorarios);
        dataField.addEventListener('change', updateHorarios);
        
        updateHorarios();
    });
</script>
{% endblock %}