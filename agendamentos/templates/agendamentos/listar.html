{% extends 'painel/base.html' %}
{% load tz %} 

{% block title %}Meus Agendamentos{% endblock %}

{% block content %}
    <h2>Meus Agendamentos</h2>

    <div style="margin-bottom: 30px;">
        <a href="{% url 'agendamentos:criar' %}" 
           style="background-color: #2563eb; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 500; transition: background-color 0.2s;">
            + Novo Agendamento
        </a>
    </div>

    {% if agendamentos %}
        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 14px;">
            <thead>
                <tr style="background-color: #f3f4f6;">
                    <th style="padding: 12px; text-align: left; color: #374151;">Serviço</th>
                    <th style="padding: 12px; text-align: left; color: #374151;">Funcionário</th>
                    <th style="padding: 12px; text-align: left; color: #374151;">Data e Hora</th>
                    <th style="padding: 12px; text-align: left; color: #374151;">Status</th>
                    <th style="padding: 12px; text-align: left; color: #374151;">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for agendamento in agendamentos %}
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px;">{{ agendamento.servico.nome }}</td>
                        <td style="padding: 12px;">{{ agendamento.funcionario.nome|default:"A definir" }}</td>
                        <td style="padding: 12px;">{{ agendamento.data_horario|date:"d/m/Y H:i" }}</td>
                        <td style="padding: 12px;">
                            <span style="font-weight: 500; color: 
                                {% if agendamento.status == 'cancelado' %} #dc2626 
                                {% elif agendamento.status == 'realizado' %} #059669 
                                {% else %} #2563eb 
                                {% endif %};">
                                {{ agendamento.status|upper }}
                            </span>
                        </td>
                        <td style="padding: 12px;">
                            {% with tempo_minimo=timezone.now|date:"Y-m-d H:i" %}
                                
                                {% if agendamento.status == 'agendado' and agendamento.data_horario|date:"Y-m-d H:i" > tempo_minimo %}
                                    
                                    <form method="POST" action="{% url 'agendamentos:cancelar' agendamento.pk %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" 
                                                onclick="return confirm('ATENÇÃO: Cancelamentos requerem 24 horas de antecedência. Tem certeza que deseja cancelar?');"
                                                style="background-color: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 500; transition: background-color 0.2s;">
                                            Cancelar
                                        </button>
                                    </form>
                                
                                {% else %}
                                    {% if agendamento.status != 'agendado' %}
                                        -
                                    {% elif agendamento.data_horario|date:"Y-m-d H:i" <= tempo_minimo %}
                                        <span style="color: #9ca3af; font-size: 12px;">(Expirado/Em andamento)</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                {% endif %}
                                
                            {% endwith %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="padding: 15px; background: white; border-radius: 4px; border: 1px dashed #bfdbfe; color: #60a5fa;">
            Nenhum agendamento encontrado. <a href="{% url 'agendamentos:criar' %}" style="color: #2563eb; text-decoration: none; font-weight: 500;">Agende seu primeiro serviço!</a>
        </p>
    {% endif %}

{% endblock content %}